{% extends "base.html" %}
{% load static %}
{% block title %}
  Админ-панель
{% endblock %}
{% block content %}
  <h2>Админ-Панель</h2>

  <h3 class="mt-5">Таблица пользователей</h3>
  
  <div class="search-grid mt-3">
    <div>
      <input type="text" class="form-control search-input" data-column="id" placeholder="Поиск по ID">
    </div>
    <div>
      <input type="text" class="form-control search-input" data-column="username" placeholder="Поиск по имени">
    </div>
    <div>
      <input type="text" class="form-control search-input" data-column="fullname" placeholder="Поиск по ФИО">
    </div>
    <div>
      <input type="text" class="form-control search-input" data-column="role" placeholder="Поиск по роли">
    </div>
  </div>

  <table class="table table-bordered mt-3">
    <thead>
      <tr>
        <th>ID</th>
        <th>Имя пользователя</th>
        <th>Зашифрованный пароль</th>
        <th>Полное имя</th>
        <th>Роль</th>
        <th>Действия</th>
      </tr>
    </thead>
    <tbody id="table-body">
      {% for user in users %}
        <tr data-id="{{ user.id }}">
          <td>{{ user.id }}</td>
          <td>
            <span class="editable-user">{{ user.username }}</span>
            <textarea class="form-control user-input d-none" 
                      rows="1" 
                      style="resize: none;
                            overflow-wrap: break-word;
                            width: 100%;"
                      data-field="username">{{ user.username }}</textarea>
            <button class="btn btn-sm btn-primary save-user d-none">Сохранить</button>
          </td>
          <td>{{ user.password }}</td>
          <td>
            <span class="editable-user">{{ user.fullname }}</span>
            <textarea class="form-control user-input d-none" 
                      rows="1" 
                      style="resize: none;
                            overflow-wrap: break-word;
                            width: 100%;"
                      data-field="fullname">{{ user.fullname }}</textarea>
            <button class="btn btn-sm btn-primary save-user d-none">Сохранить</button>
          </td>
          <td>
            <span class="editable-user">{{ user.role }}</span>
            <textarea class="form-control user-input d-none" 
                      rows="1" 
                      style="resize: none;
                            overflow-wrap: break-word;
                            width: 100%;"
                      data-field="role">{{ user.role }}</textarea>
            <button class="btn btn-sm btn-primary save-user d-none">Сохранить</button>
          </td>
          <td>
            <button class="btn btn-sm btn-danger delete-user" data-id="{{ user.id }}">Удалить</button>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="mt-3">
    <button class="btn btn-success" id="add-user-btn">Добавить пользователя</button>
  </div>

  <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addUserModalLabel">Добавить нового пользователя</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="add-user-form">
            <div class="mb-3">
              <label for="new-user-username" class="form-label">Имя пользователя</label>
              <input type="text" class="form-control" id="new-user-username" placeholder="Введите имя пользователя">
            </div>
            <div class="mb-3">
              <label for="new-user-password" class="form-label">Пароль</label>
              <input type="password" class="form-control" id="new-user-password" placeholder="Введите пароль">
            </div>
            <div class="mb-3">
              <label for="new-user-fullname" class="form-label">Полное имя</label>
              <input type="text" class="form-control" id="new-user-fullname" placeholder="Введите полное имя">
            </div>
            <div class="mb-3">
              <label for="new-user-phone-number" class="form-label">Номер телефона</label>
              <input type="text" class="form-control" id="new-user-phone-number" placeholder="Введите номер телефона">
            </div>
            <div class="mb-3">
              <label for="new-user-email" class="form-label">Электронная почта</label>
              <input type="text" class="form-control" id="new-user-email" placeholder="Введите электронную почту">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="button" class="btn btn-primary" id="save-new-user-btn">Сохранить</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const tableBody = document.getElementById("table-body");
      const searchInputs = document.querySelectorAll(".search-input");
  
      // Debounce to optimize filtering
      const debounce = (func, delay) => {
        let timeout;
        return (...args) => {
          clearTimeout(timeout);
          timeout = setTimeout(() => func(...args), delay);
        };
      };
  
      // Re-initialize events
      const initTableEvents = () => {
        // Editing
        tableBody.querySelectorAll(".editable-user").forEach((span) => {
          span.addEventListener("click", (event) => {
            const parent = event.target.closest("td");
            const textarea = parent.querySelector(".user-input");
            const saveButton = parent.querySelector(".save-user");
  
            textarea.classList.remove("d-none");
            saveButton.classList.remove("d-none");
            span.classList.add("d-none");
  
            textarea.style.height = "auto";
            textarea.style.height = `${textarea.scrollHeight}px`;
            textarea.focus();
            textarea.select();
          });
        });
  
        // Save changes
        tableBody.querySelectorAll(".save-user").forEach((button) => {
          button.addEventListener("click", (event) => {
            const row = event.target.closest("tr");
            const userId = row.dataset.id;
            const parent = event.target.closest("td");
            const textarea = parent.querySelector(".user-input");
            const span = parent.querySelector(".editable-user");
            const newValue = textarea.value.trim();
  
            if (newValue) {
              fetch(`{% url 'api:patch_user' 0 %}`.replace("0", userId), {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  [textarea.getAttribute("data-field")]: newValue,
                }),
              })
                .then((response) => response.json())
                .then((data) => {
                  if (data.status === "success") {
                    span.textContent = newValue;
                  } else {
                    alert(data.message);
                  }
                })
                .catch((error) => console.error("Ошибка:", error))
                .finally(() => {
                  textarea.classList.add("d-none");
                  span.classList.remove("d-none");
                  button.classList.add("d-none");
                });
            }
          });
        });
  
        // Delete
        tableBody.querySelectorAll(".delete-user").forEach((button) => {
          button.addEventListener("click", (event) => {
            const userId = event.target.dataset.id;
            if (confirm("Вы уверены, что хотите удалить этого пользователя?")) {
              fetch(`{% url 'api:delete_user' 0 %}`.replace("0", userId), {
                method: "DELETE",
              })
                .then((response) => response.json())
                .then((data) => {
                  if (data.status === "success") {
                    event.target.closest("tr").remove();
                  } else {
                    alert(data.message);
                  }
                })
                .catch((error) => console.error("Ошибка:", error));
            }
          });
        });
      };
  
      // Filtering and updating the table
      const fetchFilteredData = debounce(() => {
        const filters = {};
        searchInputs.forEach((input) => {
          const value = input.value.trim();
          if (value) filters[input.dataset.column] = value;
        });
  
        fetch("{% url 'api:filter_users' %}", {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
          body: JSON.stringify(filters),
        })
          .then((response) => response.json())
          .then((data) => {
            tableBody.innerHTML = "";
            if (data.users.length > 0) {
              data.users.forEach((user) => {
                const row = `
                  <tr data-id="${user.id}">
                    <td>${user.id}</td>
                    <td>
                      <span class="editable-user">${user.username}</span>
                      <textarea class="form-control user-input d-none" rows="1" data-field="username">${user.username}</textarea>
                      <button class="btn btn-sm btn-primary save-user d-none">Сохранить</button>
                    </td>
                    <td>${user.password}</td>
                    <td>
                      <span class="editable-user">${user.fullname}</span>
                      <textarea class="form-control user-input d-none" rows="1" data-field="fullname">${user.fullname}</textarea>
                      <button class="btn btn-sm btn-primary save-user d-none">Сохранить</button>
                    </td>
                    <td>
                      <span class="editable-user">${user.role}</span>
                      <textarea class="form-control user-input d-none" rows="1" data-field="role">${user.role}</textarea>
                      <button class="btn btn-sm btn-primary save-user d-none">Сохранить</button>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-danger delete-user" data-id="${user.id}">Удалить</button>
                    </td>
                  </tr>
                `;
                tableBody.insertAdjacentHTML("beforeend", row);
              });
            } else {
              tableBody.innerHTML = "<tr><td colspan='6' class='text-center'>Нет данных</td></tr>";
            }
            initTableEvents(); // Re-initialize events
          })
          .catch((error) => console.error("Ошибка при фильтрации:", error));
      }, 300);
  
      searchInputs.forEach((input) => input.addEventListener("input", fetchFilteredData));
  
      initTableEvents();

      const addUserBtn = document.getElementById("add-user-btn");
      const saveNewUserBtn = document.getElementById("save-new-user-btn");

      addUserBtn.addEventListener("click", () => {
        const addUserModal = new bootstrap.Modal(document.getElementById("addUserModal"));
        addUserModal.show();
      });

      saveNewUserBtn.addEventListener("click", () => {
        const newUser = {
          username: document.getElementById("new-user-username").value.trim(),
          password: document.getElementById("new-user-password").value.trim(),
          fullname: document.getElementById("new-user-fullname").value.trim(),
          phone_number: document.getElementById("new-user-phone-number").value.trim(),
          email: document.getElementById("new-user-email").value.trim(),
        };

        // Validate input
        if (!newUser.username || !newUser.password || !newUser.fullname || !newUser.phone_number || !newUser.email) {
          alert("Пожалуйста, заполните все поля.");
          return;
        }

        // Send data to server
        fetch("{% url 'api:add_user' %}", {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
          body: JSON.stringify(newUser),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              location.reload(); // Reload to update user list
            } else {
              alert(data.message);
            }
          })
          .catch((error) => console.error("Ошибка при добавлении пользователя:", error));
      });
    });
  </script>  
{% endblock %}
